<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DalaðŸš²Na PasaBuy</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f2f2f2;
    }
    .container {
      max-width: 500px;
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
    }
    label {
      font-weight: bold;
      margin-top: 1rem;
      display: block;
    }
    input, select, button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.4rem;
      margin-bottom: 0.8rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .item-group {
      display: flex;
      gap: 5px;
      margin-bottom: 0.5rem;
    }
    .item-group input {
      flex: 1;
    }
    .item-group button {
      background: red;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 0 0.5rem;
    }
    .summary {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
    }
    #submitBtn[disabled] {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>ðŸš² DalaNa PasaBuy</h2>
  
  <label for="store">Store *</label>
  <select id="store" required>
    <option value="">-- Select Store --</option>
    <option value="Handumanan Hypermarket">Handumanan Hypermarket</option>
    <option value="Watsons">Watsons</option>
    <option value="Mr. DIY">Mr. DIY</option>
  </select>

  <label>Items to Buy *</label>
  <div id="items-container"></div>
  <button type="button" onclick="addItem()">+ Add Item</button>

  <label>Delivery Type *</label>
  <select id="deliveryType" onchange="updateDeliveryType()" required>
    <option value="">-- Select --</option>
    <option value="today">Today</option>
    <option value="later">Later</option>
  </select>

  <label for="deliveryDate">Delivery Date *</label>
  <input type="date" id="deliveryDate" required>

  <label for="deliveryTime">Delivery Time *</label>
  <input type="time" id="deliveryTime" required>

  <label>Your Name *</label>
  <input type="text" id="customerName" required />

  <label>Phone *</label>
  <input type="tel" id="customerPhone" required />

  <label>Exact Location *</label>
  <input type="text" id="location" placeholder="Auto-detecting..." required />

  <div class="summary" id="cartSummary">
    <strong>Summary:</strong>
    <ul id="itemList"></ul>
    <p>Delivery Fee: â‚±29.99</p>
    <p>Service Fee: â‚±10.01</p>
    <p><strong>Total: â‚±<span id="totalAmount">0.00</span></strong></p>
  </div>

  <button id="submitBtn" onclick="submitOrder()" disabled>Submit via WhatsApp</button>
</div>

<script>
  let confirmationNumber = Math.floor(Math.random()*1000000);

  function addItem(name = '', qty = '') {
    const container = document.getElementById('items-container');
    const itemGroup = document.createElement('div');
    itemGroup.className = 'item-group';
    itemGroup.innerHTML = `
      <input type="text" name="itemName[]" placeholder="Item name" value="${name}" required />
      <input type="number" name="itemQty[]" placeholder="Qty" value="${qty}" min="1" required />
      <button type="button" onclick="this.parentElement.remove(); updateCartSummary();">&times;</button>
    `;
    container.appendChild(itemGroup);
    updateCartSummary();
  }

  function updateCartSummary() {
    const items = document.querySelectorAll('.item-group');
    const list = document.getElementById('itemList');
    list.innerHTML = '';
    let subtotal = 0;
    items.forEach(group => {
      const name = group.querySelector('input[type="text"]').value;
      const qty = group.querySelector('input[type="number"]').value;
      list.innerHTML += `<li>${qty} x ${name}</li>`;
      subtotal += 100 * parseInt(qty || 0); // mock pricing
    });
    let total = subtotal + 29.99 + 10.01;
    document.getElementById('totalAmount').textContent = total.toFixed(2);
    validateForm();
  }

  function updateDeliveryType() {
    const type = document.getElementById('deliveryType').value;
    const dateInput = document.getElementById('deliveryDate');
    const timeInput = document.getElementById('deliveryTime');
    const now = new Date();
    if (type === 'today') {
      const oneHourLater = new Date(now.getTime() + 60*60*1000);
      dateInput.value = now.toISOString().split('T')[0];
      dateInput.readOnly = true;
      timeInput.value = oneHourLater.toTimeString().slice(0,5);
      timeInput.readOnly = true;
    } else {
      dateInput.readOnly = false;
      timeInput.readOnly = false;
      dateInput.value = '';
      timeInput.value = '';
    }
  }

  function validateForm() {
    const requiredFields = [
      'store', 'deliveryType', 'deliveryDate', 'deliveryTime',
      'customerName', 'customerPhone', 'location'
    ];
    const allFilled = requiredFields.every(id => document.getElementById(id).value.trim() !== '') && document.querySelectorAll('.item-group').length > 0;
    document.getElementById('submitBtn').disabled = !allFilled;
  }

  function submitOrder() {
    const items = document.querySelectorAll('.item-group');
    const store = document.getElementById('store').value;
    const deliveryDate = document.getElementById('deliveryDate').value;
    const deliveryTime = document.getElementById('deliveryTime').value;
    const name = document.getElementById('customerName').value;
    const phone = document.getElementById('customerPhone').value;
    const location = document.getElementById('location').value;
    const total = document.getElementById('totalAmount').textContent;

    let itemText = '';
    items.forEach(group => {
      const name = group.querySelector('input[type="text"]').value;
      const qty = group.querySelector('input[type="number"]').value;
      itemText += `â€¢ ${qty} x ${name}\n`;
    });

    const message = `
PasaBuy Request #%23${confirmationNumber}
Store: ${store}
Items:
${itemText}
Delivery Date: ${deliveryDate} @ ${deliveryTime}
Location: ${location}
Customer: ${name}
Phone: ${phone}
Fees: â‚±29.99 (delivery) + â‚±10.01 (service)
Total: â‚±${total}`;

    const whatsappURL = `https://wa.me/63XXXXXXXXXX?text=${encodeURIComponent(message)}`;
    window.open(whatsappURL, '_blank');
  }

  function autoGeo() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`)
          .then(res => res.json())
          .then(data => {
            document.getElementById('location').value = data.display_name || `${latitude}, ${longitude}`;
            validateForm();
          });
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    addItem();
    autoGeo();
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', validateForm);
    });
  });
</script>
</body>
</html>
